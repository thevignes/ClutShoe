<%- include('../../views/partial/user/header', { user: user }) %>

<div class="container mt-4">
    <div class="row">
        <!-- Left Column for Address -->
        <div class="col-md-5">
            <div class="address_section p-3 border border-dark rounded">
                <h5>Shipping Address</h5>
                <!-- List of Addresses with Radio Buttons to Choose an Address -->
                <% addresses.forEach(function(address, index) { %>
                    <div class="mb-2 small-radio"> 
                        <input type="radio" name="selected_address" id="address<%= index %>" value="<%= address._id %>" <%=index === 0 ? 'checked' : '' %>>
                        <label for="address<%= index %>">
                            <span>Delivery to: <%= address.Firstname %></span>
                            <p><%= address.street %> <%= address.city %>, <%= address.state %> <%= address.pin %> <span> To: <%= address.type %></span></p>
                        </label>
                    </div>
                    <button class="edit-btn btn btn-link" style="background-color:#006A67; text-decoration: none; border: none;">
                        <a href="/editAddressPage/<%= address._id %>" class="text-white">Edit</a>
                    </button>
                <% }) %>

                <a href="/manageAddress">
                    <button class="btn btn-primary btn-sm mt-3">Add New Address</button>
                </a>
            </div>
        </div>

        <!-- Right Column for Order Review -->
        <div class="col-md-6 offset-md-1">
            <div class="order_review p-3 border border-dark rounded">
                <h4>Your Orders</h4>
                <div class="table-responsive order_table text-center">
                    <table class="table">
                        <thead>
                            <tr>
                                <th colspan="2">Product</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (products && products.length > 0) { %>
                                <% products.forEach(productEntry => { %>
                                    <tr>
                                        <td class="image product-thumbnail">
                                            <img src="/uploads/re-image/<%= productEntry.productId.images[0] %>" alt="<%= productEntry.productId.productName %>">
                                        </td>
                                        <td>
                                            <h5><a href="shop-product-full.html"><%= productEntry.productId.productName %></a></h5>
                                            <span class="product-qty">x <%= productEntry.quantity %></span>
                                        </td>
                                        <td>$<%= productEntry.subtotal.toFixed(2) %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="3">Your cart is empty.</td>
                                </tr>
                            <% } %>
                        
                            <tr>
                                <th>SubTotal</th>
                                <td class="product-subtotal" colspan="2">$<%= cartTotals.total.toFixed(2) %></td>
                            </tr>
                        
                            <tr>
                                <th>Shipping</th>
                                <td colspan="2"><em>Free Shipping</em></td>
                            </tr>
                        
                          
                              
                        </tbody>
                        
                    </table>
                </div>

                <!-- Coupons Section -->
                <div class="coupon_section">
                    <h5>Available Coupons</h5>
                    <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#couponModal">View Coupons</button>
                </div>

                <div class="bt-1 border-color-1 mt-3 mb-3"></div>

                <div class="payment_method">
                    <div class="mb-3">
                        <h5>Payment</h5>
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option" id="exampleRadios3" checked>
                            <label class="form-check-label" for="exampleRadios3">Direct Bank Transfer</label>
                        </div>
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option" value="COD" id="exampleRadios4">
                            <label class="form-check-label" for="exampleRadios4">Cash on Delivery</label>
                        </div>
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option" id="exampleRadios5">
                            <label class="form-check-label" for="exampleRadios5">Paypal</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-fill-out btn-block mt-3" id="placeOrderBtn">Place Order</button>
                </div>
            </div>

            <!-- Coupon Form -->
            <form id="couponForm" class="mt-3">
                <label for="couponCode">Enter Coupon Code:</label>
                <input type="text" id="couponCode" name="couponCode" class="form-control" required>
                <input type="hidden" id="orderValue" name="orderValue" value="<%= cartTotals.total.toFixed(2) %>">
                <input type="hidden" id="userId" name="userId" value="<%= userId %>">
                <button type="button" class="btn btn-primary mt-2" onclick="applyCoupon()">Apply Coupon</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Coupons -->
<div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel" aria-hidden="true">
   <div class="modal-dialog" role="document">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
               <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                   <span aria-hidden="true">&times;</span>
               </button>
           </div>
           <div class="modal-body">
               <% coupons.forEach(function(coupon) { %>
                   <div class="coupon_item">
                       <p><%= coupon.couponCode %> - <%= coupon.description %></p>
                       <button class="btn btn-sm btn-primary" onclick="copyCoupon('<%= coupon.couponCode %>')">Copy</button>
                   </div>
               <% }) %>
           </div>
       </div>
   </div>
</div>

<style>
    .address_section,
    .order_review {
        border: 2px solid #333;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }

    .address_section h5,
    .order_review h4 {
        margin-bottom: 15px;
        color: #333;
        font-weight: bold;
    }

    .small-radio input[type="radio"] {
        width: 15px;
        height: 15px;
    }

    .coupon_section {
        margin-top: 20px;
    }

    .btn-fill-out {
        background-color: #006A67;
        color: white;
    }

    .modal-body {
        max-height: 400px;
        overflow-y: auto;
    }

    .modal-dialog {
        max-width: 600px;
    }

    footer {
        width: 100%;
        background-color: #f8f9fa;
        padding: 20px 0;
    }

    footer .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px;
        text-align: center;
    }

    .container-fluid {
        width: 100%;
        padding-left: 0;
        padding-right: 0;
    }

    footer a {
        color: #006A67;
        text-decoration: none;
    }

    footer a:hover {
        text-decoration: underline;
    }
</style>

<%- include('../../views/partial/user/footer') %>


<!-- Bootstrap CSS -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS (including jQuery and Popper.js for the modal to work) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    function copyCoupon(couponCode) {
        navigator.clipboard.writeText(couponCode)
            .then(function() {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Coupon Code Copied!',
                    text: couponCode,
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
            })
            .catch(function(err) {
                console.error('Error copying text:', err);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: 'Failed to copy coupon code',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
            });
    }
</script>

        <script>
            // Show the add address form
            function showAddAddressForm() {
                document.getElementById('addressForm').style.display = 'block';
            }

            // Hide the add address form
            function hideAddressForm() {
                document.getElementById('addressForm').style.display = 'none';
            }




        </script>

        <script>
            document.getElementById('placeOrderBtn').addEventListener('click', function () {
    const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
    const selectedPaymentOption = document.querySelector('input[name="payment_option"]:checked');

    if (!selectedAddress || !selectedPaymentOption) {
        Swal.fire({
            icon: 'warning',
            title: 'Incomplete Information',
            text: 'Please select both an address and a payment option.',
            confirmButtonText: 'Okay'
        });
        return;
    }

    const data = {
        addressId: selectedAddress.value,
        paymentOption: selectedPaymentOption.value
    };

    fetch('/order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    position: "top-end",
                    icon: 'success',
                    timer: 1500,
                    title: 'Order Placed successfully',
                    text: data.message,
                    showConfirmButton: false,
                   
                }).then(() => {
                   
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Order Failed',
                    text: 'Order failed. Please try again.',
                    confirmButtonText: 'Try Again'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Server Error',
                text: 'An error occurred while placing the order.',
                confirmButtonText: 'Close'
            });
        });
});

        </script>

<script>
    async function applyCoupon() {
        const couponCode = document.getElementById('couponCode').value;
        const orderValue = parseFloat(document.getElementById('orderValue').value); 
        const userId = document.getElementById('userId').value;

        try {
            const response = await fetch('/apply-coupon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, couponCode, orderValue })
            });
            const data = await response.json();
 

            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: `Discount Applied! You saved ${data.discount.toFixed(2)}`,
                    text: `Final Price: $${data.finalPrice.toFixed(2)}`,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Unexpected Error',
                text: 'There was an error applying the coupon.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    }
</script>

