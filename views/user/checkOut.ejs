<%- include('../../views/partial/user/header', { user: user }) %>


    <div class="row">
        <!-- Left Column for Address -->
        <div class="col-md-5 ">
            <div class="address_section p-3 border border-dark rounded" style="position: absolute;
        top: 25%;
        border: black;
        left: 3%;">
                <h5>Shipping Address</h5>

                <!-- List of Addresses with Radio Buttons to Choose an Address -->
                <% addresses.forEach(function(address, index) { %>

                    
                    <div class="mb-2 small-radio">


                        <input type="radio" name="selected_address" id="address" value="<%= address._id %>"
                            id="address<%= index %>" <%=index===0 ? 'checked' : '' %>>
                        <label for="address<%= index %>">
                            <span>Delivery to: <%= address.Firstname %></span>
                            <p>
                                <%= address.street %>
                                    <%= address.city %>, <%= address.state %>
                                            <%= address.pin %> <span> To: <%=address.type%></span>
                            </p>

                        </label>



                    </div>

                    
                    <% }) %>

                        <!-- Button to Add New Address -->
                        <button class="btn btn-primary btn-sm mt-3" onclick="showAddAddressForm()">Add New
                            Address</button>

                        <!-- Add Address Form (Initially Hidden) -->
                        <div id="addressForm" class="mt-3" style="display: none;">
                            <h6>Add New Address</h6>
                            <form action="/add-address" method="POST">
                                <input type="text" name="Firstname" class="form-control mb-2" placeholder="First Name"
                                    required>
                                <input type="text" name="street" class="form-control mb-2" placeholder="Street"
                                    required>
                                <input type="text" name="city" class="form-control mb-2" placeholder="City" required>
                                <input type="text" name="state" class="form-control mb-2" placeholder="State" required>
                                <input type="text" name="pin" class="form-control mb-2" placeholder="PIN Code" required>
                                <button type="submit" class="btn btn-success btn-sm">Save Address</button>
                                <button type="button" class="btn btn-secondary btn-sm"
                                    onclick="hideAddressForm()">Cancel</button>
                            </form>
                        </div>
                   >
            </div>
        </div>

        <!-- Right Column for Order Review -->
        <div class="col-md-6 offset-md-1">
            <div class="order_review p-3 border border-dark rounded">
                <div class="mb-3">
                    <h4>Your Orders</h4>
                </div>

                <div class="table-responsive order_table text-center">
                    <table class="table">
                        <thead>
                            <tr>
                                <th colspan="2">Product</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (products && products.length> 0) { %>
                                <% products.forEach(productEntry=> { %>
                                    <tr>
                                        <td class="image product-thumbnail">
                                            <img src="/uploads/re-image/<%= productEntry.productId.images[0] %>"
                                                alt="<%= productEntry.productId.productName %>">
                                        </td>
                                        <td>
                                            <h5><a href="shop-product-full.html">
                                                    <%= productEntry.productId.productName %>
                                                </a></h5>
                                            <span class="product-qty">x <%= productEntry.quantity %></span>
                                        </td>
                                        <td>$<%= productEntry.subtotal.toFixed(2) %>
                                        </td>
                                    </tr>
                                    <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="3">Your cart is empty.</td>
                                            </tr>
                                            <% } %>
                                                <tr>
                                                    <th>SubTotal</th>
                                                    <td class="product-subtotal" colspan="2">$<%=
                                                            cartTotals.total.toFixed(2) %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Shipping</th>
                                                    <td colspan="2"><em>Free Shipping</em></td>
                                                </tr>
                                                <tr>
                                                    <th>Total</th>
                                                    <td colspan="2" class="product-subtotal">
                                                        <span class="font-xl text-brand fw-900">$<%=
                                                                cartTotals.total.toFixed(2) %></span>
                                                    </td>
                                                </tr>
                        </tbody>
                    </table>
                </div>

                <div class="bt-1 border-color-1 mt-3 mb-3"></div>
                <div class="payment_method">
                    <div class="mb-3">
                        <h5>Payment</h5>
                    </div>
                    <div class="payment_option">
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option"
                                id="exampleRadios3" checked>
                            <label class="form-check-label" for="exampleRadios3">Direct Bank Transfer</label>
                            <div class="form-group collapse show" id="bankTranfer">
                                <!-- <p class="text-muted mt-2">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration.</p> -->
                            </div>
                        </div>
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option" value="COD"
                                id="exampleRadios4">
                            <label class="form-check-label" for="exampleRadios4">Cash on Delivery</label>
                            <div class="form-group collapse" id="checkPayment">
                                <!-- <p class="text-muted mt-2">Please send your cheque to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p> -->
                            </div>
                        </div>
                        <div class="custome-radio">
                            <input class="form-check-input" required type="radio" name="payment_option"
                                id="exampleRadios5">
                            <label class="form-check-label" for="exampleRadios5">Paypal</label>
                            <div class="form-group collapse" id="paypal">

                            </div>
                        </div>
                    </div>
                </div>


                <!-- <input type="hidden" name="payment_option" value="COD" id="btn">  -->
                <!-- <!-- <input type="hidden" name="selected_address" value="address_id"> -
                <input type="hidden" name="products" value='[{"productId":"product_id_1","quantity":1},{"productId":"product_id_2","quantity":2}]'> -->




            </div>
            <button type="submit" class="btn btn-fill-out btn-block mt-3" id="placeOrderBtn">Place Order</button>
        </div>
    </div>

    <style>
        .address_section,
        .order_review {
            border: 2px solid #333;
            /* Dark border for visibility */
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .address_section h5,
        .order_review h4 {
            margin-bottom: 15px;
            color: #333;
            font-weight: bold;


        }

        /* Style to make the radio button smaller */
        .small-radio input[type="radio"] {
            width: 15px;
            height: 15px;
        }
    </style>

    <%- include('../../views/partial/user/footer') %>
        <script>
            // Show the add address form
            function showAddAddressForm() {
                document.getElementById('addressForm').style.display = 'block';
            }

            // Hide the add address form
            function hideAddressForm() {
                document.getElementById('addressForm').style.display = 'none';
            }




        </script>

        <script>
            document.getElementById('placeOrderBtn').addEventListener('click', function () {
    const selectedAddress = document.querySelector('input[name="selected_address"]:checked');
    const selectedPaymentOption = document.querySelector('input[name="payment_option"]:checked');

    if (!selectedAddress || !selectedPaymentOption) {
        Swal.fire({
            icon: 'warning',
            title: 'Incomplete Information',
            text: 'Please select both an address and a payment option.',
            confirmButtonText: 'Okay'
        });
        return;
    }

    const data = {
        addressId: selectedAddress.value,
        paymentOption: selectedPaymentOption.value
    };

    fetch('/order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    position: "top-end",
                    icon: 'success',
                    timer: 1500,
                    title: 'Order Placed successfully',
                    text: data.message,
                    showConfirmButton: false,
                   
                }).then(() => {
                   
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Order Failed',
                    text: 'Order failed. Please try again.',
                    confirmButtonText: 'Try Again'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Server Error',
                text: 'An error occurred while placing the order.',
                confirmButtonText: 'Close'
            });
        });
});

        </script>