<%-include('../../views/partial/user/header',{user:user})%>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Your Cart
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>
                                    <th scope="col">Remove from Cart</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% products.forEach(item => { %>
                                    <tr>
                                        <td class="image product-thumbnail">
                                            <img src="/uploads/re-image/<%= item.productId.images[0] %>" alt="#">
                                        </td>
                                        <td class="product-des product-name">
                                            <h5 class="product-name">
                                                <a href="shop-product-right.html"><%= item.productId.productName %></a>
                                            </h5>
                                            <p class="font-xs"><%= item.productId.description %></p>
                                        </td>
                                        <td class="price" data-title="Price">
                                            <span><%= item.productId.salePrice %></span>
                                        </td>
                                    </td>
                                    <td class="text-center" data-title="Stock">
                                        <div class="cp_quntty">
                                          <input
                                            name="quantity"
                                            min="1"
                                            max="10"
                                            value="<%= item.quantity %>" 
                                            size="2"
                                            type="number"
                                            onchange="updateQuantity('<%= item._id %>', this.value, this.max)" 
                                            style="width: 60px; text-align: center;" 
                                            data-product-id="<%= item._id %>" 
                                          />
                                        </div>
                                      </td>
                                      
                                        <td class="text-right" data-title="Cart">
                                            <span><%= item.subtotal.toFixed(2) %></span>
                                        </td>
                                        <td class="action" data-title="Remove">
                                            <a href="/remove-from-cart/<%= item._id %>" class="text-muted" onclick="return confirmRemove(event, this.href);">
                                                <i class="fi-rs-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                       
                        
                        </div>
                    </div>
                </div>
           

                <div class="cart-action text-end">
                    <a href="/shop" class="btn"><i class="fi-rs-shopping-bag mr-10"  ></i>Continue Shopping</a>
                </div>
            </div>
        </section>

            <div class="container ">
    
                <span>
                    <h3><%=message%></h3>
                    <a href="/shop">  click here to add to cart </a>
                  
                </span>
                <div class="row">
                    <div class="col-lg-6 offset-lg-6 col-md-12">
                        <div class="border p-md-4 p-30 border-radius cart-totals">
                            <div class="heading_s1 mb-3">
                                <h4>Cart Totals</h4>
                            </div>
                            <div class="table-responsive">
                                <table class="table  border-solid 1px">
                                    <tbody>
                                        <tr>
                                            <td class="cart_total_label">cart subtotal</td>
                                            <td class="cart_total_amount"><span class="font-lg fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label">Shipping</td>
                                            <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping</td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label"></td>
                                            <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                        <a href="/checkOut" class="btn"><i class="fi-rs-box-alt mr-10"></i> Proceed To Checkout</a>
                    </div>
                </div>
            </div>
        </div>
        
  
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
          async function updateQuantity(itemId, newQuantity, maxStock) {
              try {
                
              // Ensure newQuantity doesn't exceed the maxStock
              if (parseInt(newQuantity) > parseInt(maxStock)) {
                Swal.fire({
                  icon: 'error',
                  title: 'Quantity Exceeded',
                  text: `Only ${maxStock} items are available for this product.`,
                  confirmButtonText: 'OK'
                });
        
                // Reset the quantity to maxStock if the user exceeds it
                document.querySelector(`input[name="quantity"][data-product-id="${itemId}"]`).value = maxStock;
                return;  // Stop execution if quantity exceeds max
              }
              
        
              const response = await fetch("http://localhost:3100/updateQuantity", {
  method: "PATCH", // Specify the HTTP method
  headers: {
    "Content-Type": "application/json", // Set the content type to JSON
  },
  body: JSON.stringify({
    newQuantity, // Include the new quantity in the request body
    itemId, // Include the itemId in the request body
  }),
});

if (!response.ok) {
  // If the response is not okay, throw an error
  throw new Error('Failed to update quantity');
}

const data = await response.json(); // Parse the response as JSON

// Handle the response (data) if necessary
console.log(data);

        
              alert("Res2");
        
              // Reload the page to reflect the updated quantity
              window.location.reload();
            } catch (error) {
              // Handle errors gracefully
              console.error(error);
              alert('An error occurred while updating the quantity.');
            }
          }
        </script>
        

       
    
        
        
        <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->


        <!-- Including the footer outside of the table -->

    </main>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>function confirmRemove(event, href) {
        event.preventDefault();
    
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Assuming the removal action is successful
                window.location.href = href;
    
                // Add a success alert
                Swal.fire({
                    title: 'Removed!',
                    text: 'The item has been successfully removed.',
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK',
                    timer: 2000 ,
                });
            }
        });
    }

    

        // console.log('out')
        // document.getElementById("form").addEventListener("submit", async (event) => {
            //   event.preventDefault();

            //   const form = event.target;


            //   const data = {
            //     productId: form.querySelector('input[name="productId"]').value,
            //     quantity: form.querySelector('input[name="quantity"]').value
            //   };
            // const ProductId = document.getElementById('proId').value;
            // console.log("Pro: ", ProductId);


            //     fetch("/add-to-cart", {
            //       method: "post",
            //       headers: {
            //         "Content-Type": "application/json",
            //       },
            //       body: JSON.stringify({ProductId:ProductId}),
            //     })
            //     .then(response => response.json())
            //     .then((data) => {
            //         if(data.success){
            //             Swal.fire({
            //         icon: "success",
            //         title: result.message,
            //         showConfirmButton: false,
            //         timer: 1500
            //       });
            //          } else {
            //       Swal.fire({
            //         icon: "error",
            //         title: result.message || "An error occurred",
            //         showConfirmButton: true,
            //       })
            //     }
            //     })
            //    .catch ((error) => {
            //     console.error("Error adding product to cart:", error);
            //     Swal.fire({
            //       icon: "error",
            //       title: "An error occurred",
            //       text: error.message,
            //       showConfirmButton: true,
            //     });
            //    }) 


    //     });

    

    // </script>


    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    

    <%-include('../../views/partial/user/footer')%>