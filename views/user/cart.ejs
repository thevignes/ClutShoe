<%-include('../../views/partial/user/header',{user:user})%>

<style>
    :root {
        --primary: #006A67;
        --secondary: #00857f;
        --dark: #2d3436;
        --light: #ffffff;
        --shadow: 0 8px 30px rgba(0,0,0,0.1);
        --border-radius: 16px;
        --transition: all 0.3s ease;
    }

    .table-responsive {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        transition: var(--transition);
    }

    .table-responsive:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .shopping-summery {
        border-collapse: separate;
        border-spacing: 0 1rem;
        width: 100%;
    }

    .main-heading th {
        background: var(--primary);
        color: var(--light);
        padding: 1.2rem 1rem;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .main-heading th:first-child {
        border-radius: 8px 0 0 8px;
    }

    .main-heading th:last-child {
        border-radius: 0 8px 8px 0;
    }

    .shopping-summery tbody tr {
        background: var(--light);
        border-radius: 8px;
        transition: var(--transition);
    }

    .shopping-summery tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .shopping-summery td {
        padding: 1.2rem;
        vertical-align: middle;
    }

    .product-thumbnail img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 12px;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .product-thumbnail img:hover {
        transform: scale(1.05);
    }

    .product-name {
        text-align: left;
    }

    .product-name a {
        color: var(--dark);
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: var(--transition);
    }

    .product-name a:hover {
        color: var(--primary);
    }

    .product-name p {
        color: var(--dark);
        opacity: 0.7;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .price {
        font-weight: 600;
        color: var(--primary);
        font-size: 1.1rem;
    }

    .cp_quntty input {
        width: 80px;
        padding: 0.8rem;
        border: 2px solid rgba(0,0,0,0.1);
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        transition: var(--transition);
    }

    .cp_quntty input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(0, 106, 103, 0.1);
    }

    .action i {
        color: #ff3b30;
        font-size: 1.3rem;
        padding: 0.8rem;
        border-radius: 50%;
        background: rgba(255, 59, 48, 0.1);
        transition: var(--transition);
        cursor: pointer;
    }

    .action i:hover {
        transform: scale(1.1);
        background: rgba(255, 59, 48, 0.2);
    }

    .cart-action {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin: 2rem 0;
    }

    .btn {
        background: var(--primary);
        color: var(--light);
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        text-decoration: none;
        transition: var(--transition);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
    }

    .btn i {
        font-size: 1.2rem;
    }

    .btn:hover {
        background: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 106, 103, 0.2);
    }

    .cart-totals {
        background: var(--light);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .cart-totals:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .cart-totals h4 {
        color: var(--primary);
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .cart-totals table {
        width: 100%;
    }

    .cart-totals td {
        padding: 1.2rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .cart-totals .cart_total_label {
        color: var(--dark);
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .cart-totals .text-brand {
        color: var(--primary);
        font-weight: 600;
        font-size: 1.2rem;
    }

    .empty-cart-message {
        text-align: center;
        padding: 3rem 2rem;
        background: var(--light);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin: 2rem 0;
        transition: var(--transition);
    }

    .empty-cart-message:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .empty-cart-message h3 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 1.8rem;
    }

    .empty-cart-message a {
        display: inline-block;
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        margin-top: 1rem;
        padding: 0.8rem 2rem;
        border: 2px solid var(--primary);
        border-radius: 8px;
        transition: var(--transition);
    }

    .empty-cart-message a:hover {
        background: var(--primary);
        color: var(--light);
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .table-responsive {
            padding: 1rem;
        }

        .shopping-summery {
            font-size: 0.9rem;
        }

        .product-thumbnail img {
            width: 80px;
            height: 80px;
        }

        .cart-totals {
            margin-top: 2rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            font-size: 0.8rem;
        }
    }
</style>

<main class="main">
    <div class="page-header breadcrumb-wrap" data-aos="fade-down">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Your Cart
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive" data-aos="fade-up">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>
                                    <th scope="col">Remove from Cart</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% products.forEach(item => { %>
                                    <tr>
                                        <td class="image product-thumbnail">
                                            <img src="/uploads/re-image/<%= item.productId.images[0] %>" alt="#">
                                        </td>
                                        <td class="product-des product-name">
                                            <h5 class="product-name">
                                                <a href="shop-product-right.html"><%= item.productId.productName %></a>
                                            </h5>
                                            <p class="font-xs"><%= item.productId.description %></p>
                                        </td>
                                        <td class="price" data-title="Price">
                                            <span><%= item.productId.salePrice %></span>
                                        </td>
                                    </td>
                                    <td class="text-center" data-title="Stock">
                                        <div class="cp_quntty">
                                          <input
                                            name="quantity"
                                            min="1"
                                            max="<%= item.productId.stock || 10 %>"
                                            value="<%= item.quantity %>"
                                            size="2"
                                            type="number"
                                            onchange="updateQuantity('<%= item._id %>', this.value, this.max)"
                                            style="width: 60px; text-align: center;"
                                            data-product-id="<%= item._id %>"
                                          />
                                        </div>
                                      </td>
                                      
                                        <td class="text-right" data-title="Cart">
                                            <span><%= item.subtotal.toFixed(2) %></span>
                                        </td>
                                        <td class="action" data-title="Remove">
                                            <a href="/remove-from-cart/<%= item._id %>" class="text-muted" onclick="return confirmRemove(event, this.href);">
                                                <i class="fi-rs-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="cart-action text-end" data-aos="fade-up" data-aos-delay="100">
                <a href="/shop" class="btn"><i class="fi-rs-shopping-bag mr-10"  ></i>Continue Shopping</a>
            </div>
        </div>
    </section>

    <div class="container ">
    
        <% if (message) { %>
            <div class="empty-cart-message" data-aos="fade-up">
                <h3><%=message%></h3>
                <a href="/shop">Click here to add to cart</a>
            </div>
        <% } %>
        
        <div class="row">
            <div class="col-lg-6 offset-lg-6 col-md-12">
                <div class="cart-totals" data-aos="fade-left">
                    <div class="heading_s1 mb-3">
                        <h4>Cart Totals</h4>
                    </div>
                    <div class="table-responsive">
                        <table class="table  border-solid 1px">
                            <tbody>
                                <tr>
                                    <td class="cart_total_label">cart subtotal</td>
                                    <td class="cart_total_amount"><span class="font-lg fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></td>
                                </tr>
                                <tr>
                                    <td class="cart_total_label">Shipping</td>
                                    <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping</td>
                                </tr>
                                <tr>
                                    <td class="cart_total_label"></td>
                                    <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <a href="/checkOut" class="btn"><i class="fi-rs-box-alt mr-10"></i> Proceed To Checkout</a>
                </div>
            </div>
        </div>
    </div>
    <%-include('../../views/partial/user/footer')%>
</main>

<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init({
        duration: 800,
        once: true,
        offset: 100
    });

    function confirmRemove(event, href) {
        event.preventDefault();
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#006A67',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = href;
            }
        });
        return false;
    }

    function updateQuantity(itemId, value, max) {
        if (value > max) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Maximum quantity allowed is ' + max,
                confirmButtonColor: '#006A67'
            });
            return;
        }
   
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  async function updateQuantity(itemId, newQuantity, maxStock) {
      try {
        
 
      if (parseInt(newQuantity) > parseInt(maxStock)) {
        Swal.fire({
          icon: 'error',
          title: 'Quantity Exceeded',
          text: `Only ${maxStock} items are available for this product.`,
          confirmButtonText: 'OK'
        });
        
      
        document.querySelector(`input[name="quantity"][data-product-id="${itemId}"]`).value = maxStock;
        return;  
      }
      
        
      const response = await fetch("http://localhost:3100/updateQuantity", {
  method: "PATCH",
  headers: {
    "Content-Type": "application/json", 
  },
  body: JSON.stringify({
    newQuantity,
    itemId, 
  }),
});

if (!response.ok) {

  throw new Error('Failed to update quantity');
}

const data = await response.json(); 


console.log(data);

        

      window.location.reload();
    } catch (error) {
      console.error(error);
      alert('An error occurred while updating the quantity.');
    }
  }
</script>

<!-- <%-include('../../views/partial/user/footer')%> -->