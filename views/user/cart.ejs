<%-include('../../views/partial/user/header',{user:user})%>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Your Cart
            </div>
        </div>
    </div>

    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead>
                                <tr class="main-heading">
                                    <th scope="col">Image</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>
                                    <th scope="col">Remove from Cart</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% products.forEach(item => { %>
                                    <tr>
                                        <td class="image product-thumbnail">
                                            <img src="/uploads/re-image/<%= item.productId.images[0] %>" alt="#">
                                        </td>
                                        <td class="product-des product-name">
                                            <h5 class="product-name">
                                                <a href="shop-product-right.html"><%= item.productId.productName %></a>
                                            </h5>
                                            <p class="font-xs"><%= item.productId.description %></p>
                                        </td>
                                        <td class="price" data-title="Price">
                                            <span><%= item.productId.salePrice %></span>
                                        </td>
                                    </td>
                                    <td class="text-center" data-title="Stock">
                                        <div class="detail-qty border radius m-auto d-flex justify-content-center align-items-center">
                                            <a href="#" class="qty-down" onclick="this.closest('div').querySelector('.qty-val').innerText = Math.max(1, parseInt(this.closest('div').querySelector('.qty-val').innerText) - 1)">
                                                <i class="fi-rs-angle-small-down"></i>
                                            </a>
                                            <span class="qty-val" id="quantity-<%= item._id %>"><%= item.quantity %></span>
                                            <a href="#" class="qty-up" onclick="this.closest('div').querySelector('.qty-val').innerText = parseInt(this.closest('div').querySelector('.qty-val').innerText) + 1">
                                                <i class="fi-rs-angle-small-up"></i>
                                            </a>
                                        </div>
                                    </td> 
                                        <td class="text-right" data-title="Cart">
                                            <span><%= item.subtotal.toFixed(2) %></span>
                                        </td>
                                        <td class="action" data-title="Remove">
                                            <a href="/remove-from-cart/<%= item._id %>" class="text-muted" onclick="return confirmRemove(event, this.href);">
                                                <i class="fi-rs-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                       
                        
                        </div>
                    </div>
                </div>
           

                <div class="cart-action text-end">
                    <a href="/shop" class="btn"><i class="fi-rs-shopping-bag mr-10"  ></i>Continue Shopping</a>
                </div>
            </div>
        </section>

            <div class="container ">
    
                <span>
                    <h3><%=message%></h3>
                    <a href="/shop">  click here to add to cart </a>
                  
                </span>
                <div class="row">
                    <div class="col-lg-6 offset-lg-6 col-md-12">
                        <div class="border p-md-4 p-30 border-radius cart-totals">
                            <div class="heading_s1 mb-3">
                                <h4>Cart Totals</h4>
                            </div>
                            <div class="table-responsive">
                                <table class="table  border-solid 1px">
                                    <tbody>
                                        <tr>
                                            <td class="cart_total_label">cart subtotal</td>
                                            <td class="cart_total_amount"><span class="font-lg fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label">Shipping</td>
                                            <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping</td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label"></td>
                                            <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand"><%= cartTotals.total.toFixed(2) %></span></strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                        <a href="/checkOut" class="btn"><i class="fi-rs-box-alt mr-10"></i> Proceed To Checkout</a>
                    </div>
                </div>
            </div>
        </div>
        
  

<script>
     function updateQuantity(event, action, itemId, quantity) {
        event.preventDefault();  // Prevent the default anchor link behavior
        const quantityElement = document.getElementById(`quantity-${itemId}`);
        let currentQuantity = parseInt(quantityElement.innerText);

        if (action === 'increase') {
            if (currentQuantity < quantity) {
                currentQuantity += 1;
            } else {
                // Show SweetAlert if quantity exceeds available stock
                Swal.fire({
                    icon: 'error',
                    title: 'Quantity Exceeded',
                    text: `You cannot add more than the available stock of ${availableStock}.`,
                    confirmButtonText: 'OK'
                });
                return;  // Stop if stock is exceeded
            }
        } else if (action === 'decrease') {
            if (currentQuantity > 1) {
                currentQuantity -= 1;
            }
        }

        // Update the quantity displayed
        quantityElement.innerText = currentQuantity;
    }
</script>

       
    
        
        
        <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->


        <!-- Including the footer outside of the table -->

    </main>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>function confirmRemove(event, href) {
        event.preventDefault();
    
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Assuming the removal action is successful
                window.location.href = href;
    
                // Add a success alert
                Swal.fire({
                    title: 'Removed!',
                    text: 'The item has been successfully removed.',
                    icon: 'success',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK',
                    timer: 2000 ,
                });
            }
        });
    }

    

        // console.log('out')
        // document.getElementById("form").addEventListener("submit", async (event) => {
            //   event.preventDefault();

            //   const form = event.target;


            //   const data = {
            //     productId: form.querySelector('input[name="productId"]').value,
            //     quantity: form.querySelector('input[name="quantity"]').value
            //   };
            // const ProductId = document.getElementById('proId').value;
            // console.log("Pro: ", ProductId);


            //     fetch("/add-to-cart", {
            //       method: "post",
            //       headers: {
            //         "Content-Type": "application/json",
            //       },
            //       body: JSON.stringify({ProductId:ProductId}),
            //     })
            //     .then(response => response.json())
            //     .then((data) => {
            //         if(data.success){
            //             Swal.fire({
            //         icon: "success",
            //         title: result.message,
            //         showConfirmButton: false,
            //         timer: 1500
            //       });
            //          } else {
            //       Swal.fire({
            //         icon: "error",
            //         title: result.message || "An error occurred",
            //         showConfirmButton: true,
            //       })
            //     }
            //     })
            //    .catch ((error) => {
            //     console.error("Error adding product to cart:", error);
            //     Swal.fire({
            //       icon: "error",
            //       title: "An error occurred",
            //       text: error.message,
            //       showConfirmButton: true,
            //     });
            //    }) 


    //     });

    

    // </script>


    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    

    <%-include('../../views/partial/user/footer')%>